version: "3.8"
services:
  zookeeper:
    image: bitnamilegacy/zookeeper:3.9.3
    container_name: logs-zookeeper-1
    networks:
      - logs_net
    environment:
      - ALLOW_ANONYMOUS_LOGIN=yes
    healthcheck:
      test: echo srvr | nc localhost 2181 || exit 1
      interval: 10s
      timeout: 5s
      retries: 5

  kafka:
    image: bitnamilegacy/kafka:3.7.0
    container_name: logs-kafka-1
    networks:
      - logs_net
    environment:
      - KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181
      - ALLOW_PLAINTEXT_LISTENER=yes
      # Missing piece: Protocol Map batata hai ki PLAINTEXT protocol kaise behave kare
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT
      - KAFKA_CFG_LISTENERS=PLAINTEXT://0.0.0.0:9092
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
    depends_on:
      zookeeper:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics.sh --bootstrap-server localhost:9092 --list"]
      interval: 10s
      timeout: 10s
      retries: 10

  log-generator:
    image: python:3.9-slim
    container_name: logs-generator-1
    networks:
      - logs_net
    volumes:
      - ./chaos_logs.py:/app.py
      - ./logs:/home/logs
    command: python /app.py
    restart: always

  fluent-bit:
    image: fluent/fluent-bit:latest
    container_name: logs-fluent-bit-1
    user: root
    networks:
      - logs_net
    command: /fluent-bit/bin/fluent-bit -c /fluent-bit/etc/fluent-bit.yaml
    volumes:
      - ./fluent-bit/fluent-bit.yaml:/fluent-bit/etc/fluent-bit.yaml
      - ./fluent-bit/parsers.yaml:/fluent-bit/etc/parsers.yaml
      - ./logs:/home/logs
    depends_on:
      kafka:
        condition: service_healthy

networks:
  logs_net:
    name: logs_default
    external: true